<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite Financiera y de Auditor√≠a</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 95vh; background-color: #f4f6f8; color: #333; margin: 0; padding-top: 40px;}
        
        /* TABS O PESTA√ëAS */
        .tabs-container { display: flex; width: 90%; max-width: 600px; margin-bottom: 20px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; font-weight: 600; color: #555; text-decoration: none; border: none; background: #f9f9f9; font-size: 1rem; transition: all 0.3s ease; border-bottom: 3px solid transparent;}
        .tab-btn:hover { background: #f0f0f0; color: #007bff; }
        .tab-btn.active { background: #fff; color: #007bff; border-bottom: 3px solid #007bff; }
        
        /* CONTENEDOR PRINCIPAL */
        .tab-content { width: 90%; max-width: 500px; background: white; padding: 2rem; text-align: center; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        h2 { color: #000; font-weight: 600; margin-top: 0; margin-bottom: 0.5rem; }
        p { font-size: 0.95rem; color: #555; margin-bottom: 2rem; }
        
        /* FORMULARIOS */
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #333; }
        input[type="file"] { width: 100%; padding: 1.5rem 1rem; border: 2px dashed #d1d5da; border-radius: 8px; box-sizing: border-box; background-color: #f9f9f9; cursor: pointer; transition: 0.2s; }
        input[type="file"]:hover { background-color: #f3f3f3; border-color: #007bff; }
        button.submit-btn { background-color: #28a745; color: white; padding: 1rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; margin-top: 0.5rem; transition: 0.2s;}
        button.submit-btn:hover { background-color: #22863a; }
        
        /* MENSAJES Y RESULTADOS */
        .flash-message { padding: 12px; border-radius: 6px; margin-bottom: 1.5rem; font-weight: 600; font-size: 0.95rem; }
        .error { color: #d73a49; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .success { color: #004085; background-color: #cce5ff; border: 1px solid #b8daff; }
        .downloadBtn { background-color: #007bff; display: inline-block; padding: 0.8rem 2rem; margin-top: 1.5rem; text-decoration: none; color: white; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .downloadBtn:hover { background-color: #0056b3; }
        
        /* TABLA DE DASHBOARD */
        .dashboardTabla { width: 100%; border-collapse: collapse; margin-top: 1rem; margin-bottom: 1.5rem; }
        .dashboardTabla th, .dashboardTabla td { border: 1px solid #e0e0e0; padding: 10px; text-align: left; font-size: 0.95rem;}
        .dashboardTabla th { background-color: #f8f9fa; font-weight: 600; color: #333;}
        .consejoIA { margin-top: 1rem; padding: 15px; background-color: #f0f8ff; border: 1px solid #cce5ff; border-radius: 6px; font-size: 0.9rem; text-align: left; line-height: 1.5;}
        .consejoIA strong { color: #0056b3; display: block; margin-bottom: 5px; font-size: 1rem;}
        
        .logout-link { margin-top: 2rem; color: #6a737d; text-decoration: none; font-size: 0.9rem; font-weight: 500; }
        .logout-link:hover { color: #d73a49; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="tabs-container">
        <a href="/?tab=conciliador" class="tab-btn {% if tab != 'auditoria' %}active{% endif %}">ü§ñ Conciliador IA</a>
        <a href="/?tab=auditoria" class="tab-btn {% if tab == 'auditoria' %}active{% endif %}">üìë Auditor√≠a GSM</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if tab != 'auditoria' %}
    <div id="conciliador" class="tab-content">
        <h2>Herramienta de Conciliaci√≥n</h2>
        <p>Carga los archivos CFDI, Auxiliar Contable y los PDFs.</p>

        {% if success %}
            <div class="flash-message success">{{ success }}</div>
        {% endif %}

        <form action="/procesar" method="POST" enctype="multipart/form-data">
            <div class="input-group">
                <label>1. Archivo CFDI (.xlsx)</label>
                <input type="file" name="archivo_cfdi" accept=".xlsx" required>
            </div>
            <div class="input-group">
                <label>2. Archivo Auxiliar (.xlsx)</label>
                <input type="file" name="archivo_aux" accept=".xlsx" required>
            </div>
            <div class="input-group">
                <label>3. Estados de Cuenta (.zip con PDFs)</label>
                <input type="file" name="archivo_pdf" accept=".zip" required>
            </div>
            <button class="submit-btn" type="submit">Procesar Archivos</button>
        </form>

        {% if dashboard %}
            <h3 style="margin-top:30px; color:#0366d6; font-weight: 600;">Resumen de Conciliaci√≥n</h3>
            <table class="dashboardTabla">
                <thead>
                    <tr><th>Fiabilidad / Paso</th><th>Coincidencias</th></tr>
                </thead>
                <tbody>
                    {% for item in dashboard %}
                    <tr>
                        <td>{{ item.Paso }}</td>
                        <td><strong>{{ item.Coincidencias }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="consejoIA">
                <strong>üí° Resumen Anal√≠tico:</strong>
                {{ consejo }}
            </div>
            
            {% if downloadFile %}
                 <a class="downloadBtn" href="/descargar/{{ downloadFile }}">‚¨áÔ∏è Descargar Reporte y PDFs (.ZIP)</a>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}

    {% if tab == 'auditoria' %}
    <div id="auditoria" class="tab-content">
        <h2>Auditor√≠a GSM</h2>
        <p>Carga el Auxiliar unificado y el ZIP de estados de cuenta para rayar PDFs autom√°ticamente.</p>

        {% if success_auditoria %}
            <div class="flash-message success">{{ success_auditoria }}</div>
        {% endif %}

        <form action="/procesar_auditoria" method="POST" enctype="multipart/form-data">
            <div class="input-group">
                <label>1. Excel GSM Unificado (.xlsx)</label>
                <input type="file" name="archivo_excel" accept=".xlsx" required>
            </div>
            <div class="input-group">
                <label>2. Estados de Cuenta (.zip con PDFs)</label>
                <input type="file" name="archivo_pdf" accept=".zip" required>
            </div>
            <button class="submit-btn" type="submit">Ejecutar Auditor√≠a</button>
        </form>

        {% if downloadFileAuditoria %}
             <a class="downloadBtn" href="/descargar/{{ downloadFileAuditoria }}">‚¨áÔ∏è Descargar Entregables (.ZIP)</a>
        {% endif %}
    </div>
    {% endif %}

    <a href="/logout" class="logout-link">Cerrar Sesi√≥n</a>

</body>
</html>